import { Output, Directive } from '@angular/core';
import { Subject, animationFrameScheduler, of, fromEvent, distinctUntilChanged, map, mergeMap, takeUntil, tap } from 'rxjs';
import { enableSelection, preventSelection, stopPropagation } from '../common';
import * as i0 from "@angular/core";
import * as i1 from "../../ng-scrollbar-base";
import * as i2 from "../track/track";
// @dynamic
export class ThumbAdapter {
    get trackMax() {
        return this.track.size - this.size;
    }
    // Get thumb client rect
    get clientRect() {
        return this.thumbElement.getBoundingClientRect();
    }
    // Stream that emits when scrollbar thumb is clicked
    get clicked() {
        return fromEvent(this.thumbElement, 'mousedown', { passive: true }).pipe(stopPropagation());
    }
    constructor(cmp, track, thumbElement, document) {
        this.cmp = cmp;
        this.track = track;
        this.thumbElement = thumbElement;
        this.document = document;
        // Stream that emits dragging state
        this._dragging = new Subject();
        this.dragging = this._dragging.pipe(distinctUntilChanged());
    }
    // Calculate and update thumb position and size
    update() {
        const size = calculateThumbSize(this.track.size, this.viewportScrollSize, this.cmp.minThumbSize);
        const position = calculateThumbPosition(this.viewportScrollOffset, this.viewportScrollMax, this.trackMax);
        animationFrameScheduler.schedule(() => this.updateStyles(this.handleDirection(position, this.trackMax), size));
    }
    /**
     * Stream that emits the 'scrollTo' position when a scrollbar thumb element is dragged
     * This function is called by thumb drag event using viewport or scrollbar pointer events
     */
    dragged(event) {
        let trackMaxStart;
        let scrollMaxStart;
        const dragStart = of(event).pipe(preventSelection(this.document), tap(() => {
            // Capture scrollMax and trackMax once
            trackMaxStart = this.trackMax;
            scrollMaxStart = this.viewportScrollMax;
            this.setDragging(true);
        }));
        const dragging = fromEvent(this.document, 'mousemove', { capture: true, passive: true }).pipe(stopPropagation());
        const dragEnd = fromEvent(this.document, 'mouseup', { capture: true }).pipe(stopPropagation(), enableSelection(this.document), tap(() => this.setDragging(false)));
        return dragStart.pipe(map((e) => e[this.pageProperty]), map((pageOffset) => pageOffset - this.dragStartOffset), mergeMap((mouseDownOffset) => dragging.pipe(map((e) => e[this.clientProperty]), 
        // Calculate how far the pointer is from the top/left of the scrollbar (minus the dragOffset).
        map((mouseOffset) => mouseOffset - this.track.offset), map((offset) => scrollMaxStart * (offset - mouseDownOffset) / trackMaxStart), map((position) => this.handleDrag(position, scrollMaxStart)), tap((position) => this.scrollTo(position)), takeUntil(dragEnd))));
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: ThumbAdapter, deps: [{ token: i1.NgScrollbarBase }, { token: i2.TrackAdapter }, { token: HTMLElement }, { token: Document }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.1.5", type: ThumbAdapter, outputs: { dragging: "dragging" }, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: ThumbAdapter, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: i1.NgScrollbarBase }, { type: i2.TrackAdapter }, { type: HTMLElement }, { type: Document }]; }, propDecorators: { dragging: [{
                type: Output
            }] } });
/**
 * Calculate scrollbar thumb size
 */
function calculateThumbSize(trackSize, contentSize, minThumbSize) {
    const scrollbarRatio = trackSize / contentSize;
    const thumbSize = scrollbarRatio * trackSize;
    return Math.max(~~thumbSize, minThumbSize);
}
/**
 * Calculate scrollbar thumb position
 */
function calculateThumbPosition(scrollPosition, scrollMax, trackMax) {
    return scrollPosition * trackMax / scrollMax;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGh1bWIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9uZ3gtc2Nyb2xsYmFyL3NyYy9saWIvc2Nyb2xsYmFyL3RodW1iL3RodW1iLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsU0FBUyxFQUFFLE1BQU0sZUFBZSxDQUFDO0FBQ2xELE9BQU8sRUFBYyxPQUFPLEVBQUUsdUJBQXVCLEVBQUUsRUFBRSxFQUFFLFNBQVMsRUFBRSxvQkFBb0IsRUFBRSxHQUFHLEVBQUUsUUFBUSxFQUFFLFNBQVMsRUFBRSxHQUFHLEVBQUUsTUFBTSxNQUFNLENBQUM7QUFDeEksT0FBTyxFQUFFLGVBQWUsRUFBRSxnQkFBZ0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxXQUFXLENBQUM7Ozs7QUFJL0UsV0FBVztBQUVYLE1BQU0sT0FBZ0IsWUFBWTtJQXVCaEMsSUFBSSxRQUFRO1FBQ1YsT0FBTyxJQUFJLENBQUMsS0FBTSxDQUFDLElBQUksR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDO0lBQ3RDLENBQUM7SUFFRCx3QkFBd0I7SUFDeEIsSUFBSSxVQUFVO1FBQ1osT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLHFCQUFxQixFQUFFLENBQUM7SUFDbkQsQ0FBQztJQUVELG9EQUFvRDtJQUNwRCxJQUFJLE9BQU87UUFDVCxPQUFPLFNBQVMsQ0FBYSxJQUFJLENBQUMsWUFBWSxFQUFFLFdBQVcsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQyxDQUFDO0lBQzFHLENBQUM7SUFFRCxZQUFnQyxHQUFvQixFQUNwQixLQUFtQixFQUNuQixZQUF5QixFQUN6QixRQUFrQjtRQUhsQixRQUFHLEdBQUgsR0FBRyxDQUFpQjtRQUNwQixVQUFLLEdBQUwsS0FBSyxDQUFjO1FBQ25CLGlCQUFZLEdBQVosWUFBWSxDQUFhO1FBQ3pCLGFB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QUksQ0FBQyxVQUFVLENBQUMsUUFBUSxFQUFFLGNBQWMsQ0FBQyxDQUFDLEVBQ3BFLEdBQUcsQ0FBQyxDQUFDLFFBQWdCLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDLENBQUMsRUFDbEQsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUNuQixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7OEdBekZtQixZQUFZO2tHQUFaLFlBQVk7OzJGQUFaLFlBQVk7a0JBRGpDLFNBQVM7NEtBS0UsUUFBUTtzQkFBakIsTUFBTTs7QUF1R1Q7O0dBRUc7QUFDSCxTQUFTLGtCQUFrQixDQUFDLFNBQWlCLEVBQUUsV0FBbUIsRUFBRSxZQUFvQjtJQUN0RixNQUFNLGNBQWMsR0FBRyxTQUFTLEdBQUcsV0FBVyxDQUFDO0lBQy9DLE1BQU0sU0FBUyxHQUFHLGNBQWMsR0FBRyxTQUFTLENBQUM7SUFDN0MsT0FBTyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQUUsWUFBWSxDQUFDLENBQUM7QUFDN0MsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxzQkFBc0IsQ0FBQyxjQUFzQixFQUFFLFNBQWlCLEVBQUUsUUFBZ0I7SUFDekYsT0FBTyxjQUFjLEdBQUcsUUFBUSxHQUFHLFNBQVMsQ0FBQztBQUMvQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgT3V0cHV0LCBEaXJlY3RpdmUgfSBmcm9tICdAYW5ndWxhci9jb3JlJztcclxuaW1wb3J0IHsgT2JzZXJ2YWJsZSwgU3ViamVjdCwgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXIsIG9mLCBmcm9tRXZlbnQsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIG1lcmdlTWFwLCB0YWtlVW50aWwsIHRhcCB9IGZyb20gJ3J4anMnO1xyXG5pbXBvcnQgeyBlbmFibGVTZWxlY3Rpb24sIHByZXZlbnRTZWxlY3Rpb24sIHN0b3BQcm9wYWdhdGlvbiB9IGZyb20gJy4uL2NvbW1vbic7XHJcbmltcG9ydCB7IFRyYWNrQWRhcHRlciB9IGZyb20gJy4uL3RyYWNrL3RyYWNrJztcclxuaW1wb3J0IHsgTmdTY3JvbGxiYXJCYXNlIH0gZnJvbSAnLi4vLi4vbmctc2Nyb2xsYmFyLWJhc2UnO1xyXG5cclxuLy8gQGR5bmFtaWNcclxuQERpcmVjdGl2ZSgpXHJcbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBUaHVtYkFkYXB0ZXIge1xyXG5cclxuICAvLyBTdHJlYW0gdGhhdCBlbWl0cyBkcmFnZ2luZyBzdGF0ZVxyXG4gIHByaXZhdGUgX2RyYWdnaW5nID0gbmV3IFN1YmplY3Q8Ym9vbGVhbj4oKTtcclxuICBAT3V0cHV0KCkgZHJhZ2dpbmcgPSB0aGlzLl9kcmFnZ2luZy5waXBlKGRpc3RpbmN0VW50aWxDaGFuZ2VkKCkpO1xyXG5cclxuICAvLyBSZXR1cm5zIGVpdGhlciAncGFnZVgnIG9yICdwYWdlWScgYWNjb3JkaW5nIHRvIHNjcm9sbGJhciBheGlzXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCBwYWdlUHJvcGVydHkoKTogc3RyaW5nO1xyXG5cclxuICAvLyBSZXR1cm5zIGVpdGhlciAnY2xpZW50SGVpZ2h0JyBvciAnY2xpZW50V2lkdGgnIGFjY29yZGluZyB0byBzY3JvbGxiYXIgYXhpc1xyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgY2xpZW50UHJvcGVydHkoKTogc3RyaW5nO1xyXG5cclxuICBhYnN0cmFjdCBnZXQgZHJhZ1N0YXJ0T2Zmc2V0KCk6IG51bWJlcjtcclxuXHJcbiAgLy8gUmV0dXJucyB0aHVtYiBzaXplLCBjbGllbnRIZWlnaHQgb3IgY2xpZW50V2lkdGhcclxuICBhYnN0cmFjdCBnZXQgc2l6ZSgpOiBudW1iZXI7XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdmlld3BvcnRTY3JvbGxTaXplKCk6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbE9mZnNldCgpOiBudW1iZXI7XHJcblxyXG4gIGFic3RyYWN0IGdldCB2aWV3cG9ydFNjcm9sbE1heCgpOiBudW1iZXI7XHJcblxyXG4gIGdldCB0cmFja01heCgpOiBudW1iZXIge1xyXG4gICAgcmV0dXJuIHRoaXMudHJhY2shLnNpemUgLSB0aGlzLnNpemU7XHJcbiAgfVxyXG5cclxuICAvLyBHZXQgdGh1bWIgY2xpZW50IHJlY3RcclxuICBnZXQgY2xpZW50UmVjdCgpOiBET01SZWN0IHtcclxuICAgIHJldHVybiB0aGlzLnRodW1iRWxlbWVudC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcclxuICB9XHJcblxyXG4gIC8vIFN0cmVhbSB0aGF0IGVtaXRzIHdoZW4gc2Nyb2xsYmFyIHRodW1iIGlzIGNsaWNrZWRcclxuICBnZXQgY2xpY2tlZCgpOiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQ+IHtcclxuICAgIHJldHVybiBmcm9tRXZlbnQ8TW91c2VFdmVudD4odGhpcy50aHVtYkVsZW1lbnQsICdtb3VzZWRvd24nLCB7IHBhc3NpdmU6IHRydWUgfSkucGlwZShzdG9wUHJvcGFnYXRpb24oKSk7XHJcbiAgfVxyXG5cclxuICBwcm90ZWN0ZWQgY29uc3RydWN0b3IocHJvdGVjdGVkIGNtcDogTmdTY3JvbGxiYXJCYXNlLFxyXG4gICAgICAgICAgICAgICAgICAgICAgICBwcm90ZWN0ZWQgdHJhY2s6IFRyYWNrQWRhcHRlcixcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIHRodW1iRWxlbWVudDogSFRNTEVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb3RlY3RlZCBkb2N1bWVudDogRG9jdW1lbnQpIHtcclxuICB9XHJcblxyXG4gIC8vIENhbGN1bGF0ZSBhbmQgdXBkYXRlIHRodW1iIHBvc2l0aW9uIGFuZCBzaXplXHJcbiAgdXBkYXRlKCkge1xyXG4gICAgY29uc3Qgc2l6ZSA9IGNhbGN1bGF0ZVRodW1iU2l6ZSh0aGlzLnRyYWNrIS5zaXplLCB0aGlzLnZpZXdwb3J0U2Nyb2xsU2l6ZSwgdGhpcy5jbXAubWluVGh1bWJTaXplISk7XHJcbiAgICBjb25zdCBwb3NpdGlvbiA9IGNhbGN1bGF0ZVRodW1iUG9zaXRpb24odGhpcy52aWV3cG9ydFNjcm9sbE9mZnNldCwgdGhpcy52aWV3cG9ydFNjcm9sbE1heCwgdGhpcy50cmFja01heCk7XHJcbiAgICBhbmltYXRpb25GcmFtZVNjaGVkdWxlci5zY2hlZHVsZSgoKSA9PiB0aGlzLnVwZGF0ZVN0eWxlcyh0aGlzLmhhbmRsZURpcmVjdGlvbihwb3NpdGlvbiwgdGhpcy50cmFja01heCksIHNpemUpKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFN0cmVhbSB0aGF0IGVtaXRzIHRoZSAnc2Nyb2xsVG8nIHBvc2l0aW9uIHdoZW4gYSBzY3JvbGxiYXIgdGh1bWIgZWxlbWVudCBpcyBkcmFnZ2VkXHJcbiAgICogVGhpcyBmdW5jdGlvbiBpcyBjYWxsZWQgYnkgdGh1bWIgZHJhZyBldmVudCB1c2luZyB2aWV3cG9ydCBvciBzY3JvbGxiYXIgcG9pbnRlciBldmVudHNcclxuICAgKi9cclxuICBkcmFnZ2VkKGV2ZW50OiBNb3VzZUV2ZW50KTogT2JzZXJ2YWJsZTxudW1iZXI+IHtcclxuICAgIGxldCB0cmFja01heFN0YXJ0OiBudW1iZXI7XHJcbiAgICBsZXQgc2Nyb2xsTWF4U3RhcnQ6IG51bWJlcjtcclxuXHJcbiAgICBjb25zdCBkcmFnU3RhcnQ6IE9ic2VydmFibGU8TW91c2VFdmVudD4gPSBvZjxNb3VzZUV2ZW50PihldmVudCkucGlwZShcclxuICAgICAgcHJldmVudFNlbGVjdGlvbih0aGlzLmRvY3VtZW50KSxcclxuICAgICAgdGFwKCgpID0+IHtcclxuICAgICAgICAvLyBDYXB0dXJlIHNjcm9sbE1heCBhbmQgdHJhY2tNYXggb25jZVxyXG4gICAgICAgIHRyYWNrTWF4U3RhcnQgPSB0aGlzLnRyYWNrTWF4O1xyXG4gICAgICAgIHNjcm9sbE1heFN0YXJ0ID0gdGhpcy52aWV3cG9ydFNjcm9sbE1heDtcclxuICAgICAgICB0aGlzLnNldERyYWdnaW5nKHRydWUpO1xyXG4gICAgICB9KSxcclxuICAgICk7XHJcblxyXG4gICAgY29uc3QgZHJhZ2dpbmc6IE9ic2VydmFibGU8TW91c2VFdmVudD4gPSBmcm9tRXZlbnQ8TW91c2VFdmVudD4odGhpcy5kb2N1bWVudCwgJ21vdXNlbW92ZScsIHsgY2FwdHVyZTogdHJ1ZSwgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKHN0b3BQcm9wYWdhdGlvbigpKTtcclxuXHJcbiAgICBjb25zdCBkcmFnRW5kOiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQ+ID0gZnJvbUV2ZW50PE1vdXNlRXZlbnQ+KHRoaXMuZG9jdW1lbnQsICdtb3VzZXVwJywgeyBjYXB0dXJlOiB0cnVlIH0pLnBpcGUoXHJcbiAgICAgIHN0b3BQcm9wYWdhdGlvbigpLFxyXG4gICAgICBlbmFibGVTZWxlY3Rpb24odGhpcy5kb2N1bWVudCksXHJcbiAgICAgIHRhcCgoKSA9PiB0aGlzLnNldERyYWdnaW5nKGZhbHNlKSlcclxuICAgICk7XHJcblxyXG4gICAgcmV0dXJuIGRyYWdTdGFydC5waXBlKFxyXG4gICAgICBtYXAoKGU6IE1vdXNlRXZlbnQpID0+IGVbdGhpcy5wYWdlUHJvcGVydHldKSxcclxuICAgICAgbWFwKChwYWdlT2Zmc2V0OiBudW1iZXIpID0+IHBhZ2VPZmZzZXQgLSB0aGlzLmRyYWdTdGFydE9mZnNldCksXHJcbiAgICAgIG1lcmdlTWFwKChtb3VzZURvd25PZmZzZXQ6IG51bWJlcikgPT4gZHJhZ2dpbmcucGlwZShcclxuICAgICAgICBtYXAoKGU6IE1vdXNlRXZlbnQpID0+IGVbdGhpcy5jbGllbnRQcm9wZXJ0eV0pLFxyXG4gICAgICAgIC8vIENhbGN1bGF0ZSBob3cgZmFyIHRoZSBwb2ludGVyIGlzIGZyb20gdGhlIHRvcC9sZWZ0IG9mIHRoZSBzY3JvbGxiYXIgKG1pbnVzIHRoZSBkcmFnT2Zmc2V0KS5cclxuICAgICAgICBtYXAoKG1vdXNlT2Zmc2V0OiBudW1iZXIpID0+IG1vdXNlT2Zmc2V0IC0gdGhpcy50cmFjayEub2Zmc2V0KSxcclxuICAgICAgICBtYXAoKG9mZnNldDogbnVtYmVyKSA9PiBzY3JvbGxNYXhTdGFydCAqIChvZmZzZXQgLSBtb3VzZURvd25PZmZzZXQpIC8gdHJhY2tNYXhTdGFydCksXHJcbiAgICAgICAgbWFwKChwb3NpdGlvbjogbnVtYmVyKSA9PiB0aGlzLmhhbmRsZURyYWcocG9zaXRpb24sIHNjcm9sbE1heFN0YXJ0KSksXHJcbiAgICAgICAgdGFwKChwb3NpdGlvbjogbnVtYmVyKSA9PiB0aGlzLnNjcm9sbFRvKHBvc2l0aW9uKSksXHJcbiAgICAgICAgdGFrZVVudGlsKGRyYWdFbmQpXHJcbiAgICAgICkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gU2V0IGRyYWdnaW5nIHN0YXRlXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IHNldERyYWdnaW5nKHZhbHVlOiBib29sZWFuKTogdm9pZDtcclxuXHJcbiAgLy8gU2Nyb2xsIHZpZXdwb3J0IGluc3RhbnRseVxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzY3JvbGxUbyhwb3NpdGlvbjogbnVtYmVyKTogdm9pZDtcclxuXHJcbiAgLy8gVXBkYXRlIHRodW1iIGVsZW1lbnQgc2l6ZSBhbmQgcG9zaXRpb25cclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgdXBkYXRlU3R5bGVzKHBvc2l0aW9uOiBudW1iZXIsIHNpemU6IG51bWJlcik6IHZvaWQ7XHJcblxyXG4gIC8vIEhhbmRsZSBkcmFnZ2luZyBwb3NpdGlvbiAoU3VwcG9ydCBMVFIgYW5kIFJUTCBkaXJlY3Rpb25zIGZvciB0aGUgaG9yaXpvbnRhbCBzY3JvbGxiYXIpXHJcbiAgcHJvdGVjdGVkIGFic3RyYWN0IGhhbmRsZURyYWcocG9zaXRpb246IG51bWJlciwgc2Nyb2xsTWF4PzogbnVtYmVyKTogbnVtYmVyO1xyXG5cclxuICAvLyBIYW5kbGUgc2Nyb2xsaW5nIHBvc2l0aW9uIChTdXBwb3J0IExUUiBhbmQgUlRMIGRpcmVjdGlvbnMgZm9yIHRoZSBob3Jpem9udGFsIHNjcm9sbGJhcilcclxuICBwcm90ZWN0ZWQgYWJzdHJhY3QgaGFuZGxlRGlyZWN0aW9uKHBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heD86IG51bWJlcik6IG51bWJlcjtcclxufVxyXG5cclxuLyoqXHJcbiAqIENhbGN1bGF0ZSBzY3JvbGxiYXIgdGh1bWIgc2l6ZVxyXG4gKi9cclxuZnVuY3Rpb24gY2FsY3VsYXRlVGh1bWJTaXplKHRyYWNrU2l6ZTogbnVtYmVyLCBjb250ZW50U2l6ZTogbnVtYmVyLCBtaW5UaHVtYlNpemU6IG51bWJlcik6IG51bWJlciB7XHJcbiAgY29uc3Qgc2Nyb2xsYmFyUmF0aW8gPSB0cmFja1NpemUgLyBjb250ZW50U2l6ZTtcclxuICBjb25zdCB0aHVtYlNpemUgPSBzY3JvbGxiYXJSYXRpbyAqIHRyYWNrU2l6ZTtcclxuICByZXR1cm4gTWF0aC5tYXgofn50aHVtYlNpemUsIG1pblRodW1iU2l6ZSk7XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBDYWxjdWxhdGUgc2Nyb2xsYmFyIHRodW1iIHBvc2l0aW9uXHJcbiAqL1xyXG5mdW5jdGlvbiBjYWxjdWxhdGVUaHVtYlBvc2l0aW9uKHNjcm9sbFBvc2l0aW9uOiBudW1iZXIsIHNjcm9sbE1heDogbnVtYmVyLCB0cmFja01heDogbnVtYmVyKTogbnVtYmVyIHtcclxuICByZXR1cm4gc2Nyb2xsUG9zaXRpb24gKiB0cmFja01heCAvIHNjcm9sbE1heDtcclxufVxyXG4iXX0=