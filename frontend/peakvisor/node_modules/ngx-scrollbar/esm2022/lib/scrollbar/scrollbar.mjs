import { Directive } from '@angular/core';
import { Subject, fromEvent, merge, distinctUntilChanged, map, switchMap, takeUntil, tap } from 'rxjs';
import { isWithinBounds, stopPropagation } from './common';
import * as i0 from "@angular/core";
import * as i1 from "../ng-scrollbar-base";
import * as i2 from "@angular/cdk/platform";
// @dynamic
export class Scrollbar {
    constructor(el, cmp, platform, document, zone) {
        this.el = el;
        this.cmp = cmp;
        this.platform = platform;
        this.document = document;
        this.zone = zone;
        // Stream that emits to unsubscribe from all streams
        this.destroyed = new Subject();
    }
    /**
     * Activate scrollbar pointer events
     */
    activatePointerEvents() {
        // Stream that emits when scrollbar thumb is dragged
        let thumbDragEvent;
        // Stream that emits when scrollbar track is clicked
        let trackClickEvent;
        // Stream that emits when scrollbar track is hovered
        let trackHoveredEvent;
        // Set the method used for the pointer events option
        if (this.cmp.pointerEventsMethod === 'viewport') {
            // Pointer events using the viewport
            this.viewportTrackClicked = new Subject();
            this.viewportThumbClicked = new Subject();
            // Activate the pointer events of the viewport directive
            this.cmp.viewport.activatePointerEvents(this.cmp.viewportPropagateMouseMove, this.destroyed);
            // Set streams
            thumbDragEvent = this.viewportThumbClicked;
            trackClickEvent = this.viewportTrackClicked;
            trackHoveredEvent = this.cmp.viewport.hovered.pipe(
            // Check if track is hovered
            map((e) => e ? isWithinBounds(e, this.el.getBoundingClientRect()) : false), distinctUntilChanged(), 
            // Enable / disable text selection
            tap((hovered) => this.document.onselectstart = hovered ? () => false : null));
            this.cmp.viewport.clicked.pipe(tap((e) => {
                if (e) {
                    if (isWithinBounds(e, this.thumb.clientRect)) {
                        this.viewportThumbClicked.next(e);
                    }
                    else if (isWithinBounds(e, this.track.clientRect)) {
                        this.cmp.setClicked(true);
                        this.viewportTrackClicked.next(e);
                    }
                }
                else {
                    this.cmp.setClicked(false);
                }
            }), takeUntil(this.destroyed)).subscribe();
        }
        else {
            // Pointer events method is using 'scrollbar'
            thumbDragEvent = this.thumb.clicked;
            trackClickEvent = this.track.clicked;
            trackHoveredEvent = this.hovered;
        }
        return merge(
        // Activate scrollbar hovered event
        trackHoveredEvent.pipe(tap((e) => this.setHovered(e))), 
        // Activate scrollbar thumb drag event
        thumbDragEvent.pipe(switchMap((e) => this.thumb.dragged(e))), 
        // Activate scrollbar track click event
        trackClickEvent.pipe(switchMap((e) => this.track.onTrackClicked(e, this.thumb.size, this.viewportScrollSize))));
    }
    // Stream that emits when the track element is hovered
    get hovered() {
        const mouseEnter = fromEvent(this.el, 'mouseenter', { passive: true }).pipe(stopPropagation(), map(() => true));
        const mouseLeave = fromEvent(this.el, 'mouseleave', { passive: true }).pipe(stopPropagation(), map(() => false));
        return merge(mouseEnter, mouseLeave);
    }
    ngOnInit() {
        this.zone.runOutsideAngular(() => {
            // Activate pointer events on Desktop only
            if (!(this.platform.IOS || this.platform.ANDROID) && !this.cmp.pointerEventsDisabled) {
                this.activatePointerEvents().pipe(takeUntil(this.destroyed)).subscribe();
            }
            // Update scrollbar thumb when viewport is scrolled and when scrollbar component is updated
            merge(this.cmp.scrolled, this.cmp.updated).pipe(tap(() => this.thumb?.update()), takeUntil(this.destroyed)).subscribe();
        });
    }
    ngOnDestroy() {
        this.destroyed.next();
        this.destroyed.complete();
        // Clean up viewport streams if used
        if (this.viewportThumbClicked && this.viewportTrackClicked) {
            this.viewportTrackClicked.complete();
            this.viewportThumbClicked.complete();
        }
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: Scrollbar, deps: [{ token: HTMLElement }, { token: i1.NgScrollbarBase }, { token: i2.Platform }, { token: Document }, { token: i0.NgZone }], target: i0.ɵɵFactoryTarget.Directive }); }
    static { this.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "16.1.5", type: Scrollbar, ngImport: i0 }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.1.5", ngImport: i0, type: Scrollbar, decorators: [{
            type: Directive
        }], ctorParameters: function () { return [{ type: HTMLElement }, { type: i1.NgScrollbarBase }, { type: i2.Platform }, { type: Document }, { type: i0.NgZone }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2Nyb2xsYmFyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vLi4vcHJvamVjdHMvbmd4LXNjcm9sbGJhci9zcmMvbGliL3Njcm9sbGJhci9zY3JvbGxiYXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUE2QixTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFFckUsT0FBTyxFQUFjLE9BQU8sRUFBRSxTQUFTLEVBQUUsS0FBSyxFQUFFLG9CQUFvQixFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsU0FBUyxFQUFFLEdBQUcsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUluSCxPQUFPLEVBQUUsY0FBYyxFQUFFLGVBQWUsRUFBRSxNQUFNLFVBQVUsQ0FBQzs7OztBQUUzRCxXQUFXO0FBRVgsTUFBTSxPQUFnQixTQUFTO0lBa0I3QixZQUFnQyxFQUFlLEVBQ2xCLEdBQW9CLEVBQ2pCLFFBQWtCLEVBQ2xCLFFBQWtCLEVBQ2xCLElBQVk7UUFKWixPQUFFLEdBQUYsRUFBRSxDQUFhO1FBQ2xCLFFBQUcsR0FBSCxHQUFHLENBQWlCO1FBQ2pCLGFBQVEsR0FBUixRQUFRLENBQVU7UUFDbEIsYUFBUSxHQUFSLFFBQVEsQ0FBVTtRQUNsQixTQUFJLEdBQUosSUFBSSxDQUFRO1FBaEI1QyxvREFBb0Q7UUFDakMsY0FBUyxHQUFHLElBQUksT0FBTyxFQUFRLENBQUM7SUFnQm5ELENBQUM7SUFFRDs7T0FFRztJQUNLLHFCQUFxQjtRQUMzQixvREFBb0Q7UUFDcEQsSUFBSSxjQUFzQyxDQUFDO1FBQzNDLG9EQUFvRDtRQUNwRCxJQUFJLGVBQXVDLENBQUM7UUFDNUMsb0RBQW9EO1FBQ3BELElBQUksaUJBQXNDLENBQUM7UUFFM0Msb0RBQW9EO1FBQ3BELElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxtQkFBbUIsS0FBSyxVQUFVLEVBQUU7WUFDL0Msb0NBQW9DO1lBQ3BDLElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBYyxDQUFDO1lBQ3RELElBQUksQ0FBQyxvQkFBb0IsR0FBRyxJQUFJLE9BQU8sRUFBYyxDQUFDO1lBRXRELHdEQUF3RDtZQUN4RCxJQUFJLENBQUMsR0FBRyxDQUFDLFFBQVMsQ0FBQyxxQkFBcUIsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLDBCQUEwQixFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUU5RixjQUFjO1lBQ2QsY0FBYyxHQUFHLElBQUksQ0FBQyxvQkFBb0IsQ0FBQztZQUMzQyxlQUFlLEdBQUcsSUFBSSxDQUFDLG9CQUFvQixDQUFDO1lBQzVDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUyxDQUFDLE9BQU8sQ0FBQyxJQUFJO1lBQ2pELDRCQUE0QjtZQUM1QixHQUFHLENBQUMsQ0FBQyxDQUFxQixFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEVBQUUsQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUM5RixvQkFBb0IsRUFBRTtZQUN0QixrQ0FBa0M7WUFDbEMsR0FBRyxDQUFDLENBQUMsT0FBZ0IsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxhQUFhLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksQ0FBQyxDQUN0RixDQUFDO1lBRUYsSUFBSSxDQUFDLEdBQUcsQ0FBQyxRQUFTLENBQUMsT0FBTyxDQUFDLElBQUksQ0FDN0IsR0FBRyxDQUFDLENBQUMsQ0FBcUIsRUFBRSxFQUFFO2dCQUM1QixJQUFJLENBQUMsRUFBRTtvQkFDTCxJQUFJLGNBQWMsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQU0sQ0FBQyxVQUFVLENBQUMsRUFBRTt3QkFDN0MsSUFBSSxDQUFDLG9CQUFvQixDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztxQkFDbkM7eUJBQU0sSUFBSSxjQUFjLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFNLENBQUMsVUFBVSxDQUFDLEVBQUU7d0JBQ3BELElBQUksQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDO3dCQUMxQixJQUFJLENBQUMsb0JBQW9CLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDO3FCQUNuQztpQkFDRjtxQkFBTTtvQkFDTCxJQUFJLENBQUMsR0FBRyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsQ0FBQztpQkFDNUI7WUFDSCxDQUFDLENBQUMsRUFDRixTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQixDQUFDLFNBQVMsRUFBRSxDQUFDO1NBQ2Y7YUFBTTtZQUNMLDZDQUE2QztZQUM3QyxjQUFjLEdBQUcsSUFBSSxDQUFDLEtBQU0sQ0FBQyxPQUFPLENBQUM7WUFDckMsZUFBZSxHQUFHLElBQUksQ0FBQyxLQUFNLENBQUMsT0FBTyxDQUFDO1lBQ3RDLGlCQUFpQixHQUFHLElBQUksQ0FBQyxPQUFPLENBQUM7U0FDbEM7UUFFRCxPQUFPLEtBQUs7UUFDVixtQ0FBbUM7UUFDbkMsaUJBQWlCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQVUsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQy9ELHNDQUFzQztRQUN0QyxjQUFjLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQWEsRUFBRSxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQU0sQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUN6RSx1Q0FBdUM7UUFDdkMsZUFBZSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFhLEVBQUUsRUFBRSxDQUFDLElBQUksQ0FBQyxLQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBTSxDQUFDLElBQUksRUFBRSxJQUFJLENBQUMsa0JBQWtCLENBQUMsQ0FBQyxDQUFDLENBQzdILENBQUM7SUFDSixDQUFDO0lBRUQsc0RBQXNEO0lBQ3RELElBQWMsT0FBTztRQUNuQixNQUFNLFVBQVUsR0FBRyxTQUFTLENBQWEsSUFBSSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQ3JGLGVBQWUsRUFBRSxFQUNqQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLENBQ2hCLENBQUM7UUFDRixNQUFNLFVBQVUsR0FBRyxTQUFTLENBQWEsSUFBSSxDQUFDLEVBQUUsRUFBRSxZQUFZLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQ3JGLGVBQWUsRUFBRSxFQUNqQixHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsS0FBSyxDQUFDLENBQ2pCLENBQUM7UUFDRixPQUFPLEtBQUssQ0FBQyxVQUFVLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVELFFBQVE7UUFDTixJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixDQUFDLEdBQUcsRUFBRTtZQUMvQiwwQ0FBMEM7WUFDMUMsSUFBSSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMscUJBQXFCLEVBQUU7Z0JBQ3BGLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUFFLENBQUM7YUFDMUU7WUFFRCwyRkFBMkY7WUFDM0YsS0FBSyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLElBQUksQ0FBQyxHQUFHLENBQUMsT0FBTyxDQUFDLENBQUMsSUFBSSxDQUM3QyxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLEVBQUUsQ0FBQyxFQUMvQixTQUFTLENBQUMsSUFBSSxDQUFDLFNBQVMsQ0FBQyxDQUMxQixDQUFDLFNBQVMsRUFBRSxDQUFDO1FBQ2hCLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVELFdBQVc7UUFDVCxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3RCLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxFQUFFLENBQUM7UUFFMUIsb0NBQW9DO1FBQ3BDLElBQUksSUFBSSxDQUFDLG9CQUFvQixJQUFJLElBQUksQ0FBQyxvQkFBb0IsRUFBRTtZQUMxRCxJQUFJLENBQUMsb0JBQW9CLENBQUMsUUFBUSxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLFFBQVEsRUFBRSxDQUFDO1NBQ3RDO0lBQ0gsQ0FBQzs4R0E3SG1CLFNBQVM7a0dBQVQsU0FBUzs7MkZBQVQsU0FBUztrQkFEOUIsU0FBUyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IE9uRGVzdHJveSwgT25Jbml0LCBOZ1pvbmUsIERpcmVjdGl2ZSB9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQgeyBQbGF0Zm9ybSB9IGZyb20gJ0Bhbmd1bGFyL2Nkay9wbGF0Zm9ybSc7XHJcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QsIGZyb21FdmVudCwgbWVyZ2UsIGRpc3RpbmN0VW50aWxDaGFuZ2VkLCBtYXAsIHN3aXRjaE1hcCwgdGFrZVVudGlsLCB0YXAgfSBmcm9tICdyeGpzJztcclxuaW1wb3J0IHsgTmdTY3JvbGxiYXJCYXNlIH0gZnJvbSAnLi4vbmctc2Nyb2xsYmFyLWJhc2UnO1xyXG5pbXBvcnQgeyBUaHVtYkFkYXB0ZXIgfSBmcm9tICcuL3RodW1iL3RodW1iJztcclxuaW1wb3J0IHsgVHJhY2tBZGFwdGVyIH0gZnJvbSAnLi90cmFjay90cmFjayc7XHJcbmltcG9ydCB7IGlzV2l0aGluQm91bmRzLCBzdG9wUHJvcGFnYXRpb24gfSBmcm9tICcuL2NvbW1vbic7XHJcblxyXG4vLyBAZHluYW1pY1xyXG5ARGlyZWN0aXZlKClcclxuZXhwb3J0IGFic3RyYWN0IGNsYXNzIFNjcm9sbGJhciBpbXBsZW1lbnRzIE9uSW5pdCwgT25EZXN0cm95IHtcclxuXHJcbiAgLy8gVGh1bWIgZGlyZWN0aXZlIHJlZmVyZW5jZVxyXG4gIHJlYWRvbmx5IHRodW1iOiBUaHVtYkFkYXB0ZXIgfCB1bmRlZmluZWQ7XHJcbiAgLy8gVHJhY2sgZGlyZWN0aXZlIHJlZmVyZW5jZVxyXG4gIHJlYWRvbmx5IHRyYWNrOiBUcmFja0FkYXB0ZXIgfCB1bmRlZmluZWQ7XHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgdG8gdW5zdWJzY3JpYmUgZnJvbSBhbGwgc3RyZWFtc1xyXG4gIHByb3RlY3RlZCByZWFkb25seSBkZXN0cm95ZWQgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xyXG5cclxuICAvKipcclxuICAgKiBWaWV3cG9ydCBwb2ludGVyIGV2ZW50c1xyXG4gICAqIFRoZSBmb2xsb3dpbmcgc3RyZWFtcyBhcmUgb25seSBhY3RpdmF0ZWQgd2hlbiAocG9pbnRlckV2ZW50c01ldGhvZCA9PT0gJ3ZpZXdwb3J0JylcclxuICAgKi9cclxuICBwcm90ZWN0ZWQgdmlld3BvcnRUcmFja0NsaWNrZWQhOiBTdWJqZWN0PE1vdXNlRXZlbnQ+O1xyXG4gIHByb3RlY3RlZCB2aWV3cG9ydFRodW1iQ2xpY2tlZCE6IFN1YmplY3Q8TW91c2VFdmVudD47XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBnZXQgdmlld3BvcnRTY3JvbGxTaXplKCk6IG51bWJlcjtcclxuXHJcbiAgcHJvdGVjdGVkIGNvbnN0cnVjdG9yKHByb3RlY3RlZCBlbDogSFRNTEVsZW1lbnQsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHB1YmxpYyBjbXA6IE5nU2Nyb2xsYmFyQmFzZSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIHBsYXRmb3JtOiBQbGF0Zm9ybSxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIGRvY3VtZW50OiBEb2N1bWVudCxcclxuICAgICAgICAgICAgICAgICAgICAgICAgcHJvdGVjdGVkIHpvbmU6IE5nWm9uZSkge1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQWN0aXZhdGUgc2Nyb2xsYmFyIHBvaW50ZXIgZXZlbnRzXHJcbiAgICovXHJcbiAgcHJpdmF0ZSBhY3RpdmF0ZVBvaW50ZXJFdmVudHMoKTogT2JzZXJ2YWJsZTx1bmtub3duPiB7XHJcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0aHVtYiBpcyBkcmFnZ2VkXHJcbiAgICBsZXQgdGh1bWJEcmFnRXZlbnQ6IE9ic2VydmFibGU8TW91c2VFdmVudD47XHJcbiAgICAvLyBTdHJlYW0gdGhhdCBlbWl0cyB3aGVuIHNjcm9sbGJhciB0cmFjayBpcyBjbGlja2VkXHJcbiAgICBsZXQgdHJhY2tDbGlja0V2ZW50OiBPYnNlcnZhYmxlPE1vdXNlRXZlbnQ+O1xyXG4gICAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiBzY3JvbGxiYXIgdHJhY2sgaXMgaG92ZXJlZFxyXG4gICAgbGV0IHRyYWNrSG92ZXJlZEV2ZW50OiBPYnNlcnZhYmxlPGJvb2xlYW4+O1xyXG5cclxuICAgIC8vIFNldCB0aGUgbWV0aG9kIHVzZWQgZm9yIHRoZSBwb2ludGVyIGV2ZW50cyBvcHRpb25cclxuICAgIGlmICh0aGlzLmNtcC5wb2ludGVyRXZlbnRzTWV0aG9kID09PSAndmlld3BvcnQnKSB7XHJcbiAgICAgIC8vIFBvaW50ZXIgZXZlbnRzIHVzaW5nIHRoZSB2aWV3cG9ydFxyXG4gICAgICB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkID0gbmV3IFN1YmplY3Q8TW91c2VFdmVudD4oKTtcclxuICAgICAgdGhpcy52aWV3cG9ydFRodW1iQ2xpY2tlZCA9IG5ldyBTdWJqZWN0PE1vdXNlRXZlbnQ+KCk7XHJcblxyXG4gICAgICAvLyBBY3RpdmF0ZSB0aGUgcG9pbnRlciBldmVudHMgb2YgdGhlIHZpZXdwb3J0IGRpcmVjdGl2ZVxyXG4gICAgICB0aGlzLmNtcC52aWV3cG9ydCEuYWN0aXZhdGVQb2ludGVyRXZlbnRzKHRoaXMuY21wLnZpZXdwb3J0UHJvcGFnYXRlTW91c2VNb3ZlLCB0aGlzLmRlc3Ryb3llZCk7XHJcblxyXG4gICAgICAvLyBTZXQgc3RyZWFtc1xyXG4gICAgICB0aHVtYkRyYWdFdmVudCA9IHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQ7XHJcbiAgICAgIHRyYWNrQ2xpY2tFdmVudCA9IHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQ7XHJcbiAgICAgIHRyYWNrSG92ZXJlZEV2ZW50ID0gdGhpcy5jbXAudmlld3BvcnQhLmhvdmVyZWQucGlwZShcclxuICAgICAgICAvLyBDaGVjayBpZiB0cmFjayBpcyBob3ZlcmVkXHJcbiAgICAgICAgbWFwKChlOiBNb3VzZUV2ZW50IHwgZmFsc2UpID0+IGUgPyBpc1dpdGhpbkJvdW5kcyhlLCB0aGlzLmVsLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpKSA6IGZhbHNlKSxcclxuICAgICAgICBkaXN0aW5jdFVudGlsQ2hhbmdlZCgpLFxyXG4gICAgICAgIC8vIEVuYWJsZSAvIGRpc2FibGUgdGV4dCBzZWxlY3Rpb25cclxuICAgICAgICB0YXAoKGhvdmVyZWQ6IGJvb2xlYW4pID0+IHRoaXMuZG9jdW1lbnQub25zZWxlY3RzdGFydCA9IGhvdmVyZWQgPyAoKSA9PiBmYWxzZSA6IG51bGwpXHJcbiAgICAgICk7XHJcblxyXG4gICAgICB0aGlzLmNtcC52aWV3cG9ydCEuY2xpY2tlZC5waXBlKFxyXG4gICAgICAgIHRhcCgoZTogTW91c2VFdmVudCB8IGZhbHNlKSA9PiB7XHJcbiAgICAgICAgICBpZiAoZSkge1xyXG4gICAgICAgICAgICBpZiAoaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50aHVtYiEuY2xpZW50UmVjdCkpIHtcclxuICAgICAgICAgICAgICB0aGlzLnZpZXdwb3J0VGh1bWJDbGlja2VkLm5leHQoZSk7XHJcbiAgICAgICAgICAgIH0gZWxzZSBpZiAoaXNXaXRoaW5Cb3VuZHMoZSwgdGhpcy50cmFjayEuY2xpZW50UmVjdCkpIHtcclxuICAgICAgICAgICAgICB0aGlzLmNtcC5zZXRDbGlja2VkKHRydWUpO1xyXG4gICAgICAgICAgICAgIHRoaXMudmlld3BvcnRUcmFja0NsaWNrZWQubmV4dChlKTtcclxuICAgICAgICAgICAgfVxyXG4gICAgICAgICAgfSBlbHNlIHtcclxuICAgICAgICAgICAgdGhpcy5jbXAuc2V0Q2xpY2tlZChmYWxzZSk7XHJcbiAgICAgICAgICB9XHJcbiAgICAgICAgfSksXHJcbiAgICAgICAgdGFrZVVudGlsKHRoaXMuZGVzdHJveWVkKVxyXG4gICAgICApLnN1YnNjcmliZSgpO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgLy8gUG9pbnRlciBldmVudHMgbWV0aG9kIGlzIHVzaW5nICdzY3JvbGxiYXInXHJcbiAgICAgIHRodW1iRHJhZ0V2ZW50ID0gdGhpcy50aHVtYiEuY2xpY2tlZDtcclxuICAgICAgdHJhY2tDbGlja0V2ZW50ID0gdGhpcy50cmFjayEuY2xpY2tlZDtcclxuICAgICAgdHJhY2tIb3ZlcmVkRXZlbnQgPSB0aGlzLmhvdmVyZWQ7XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIG1lcmdlKFxyXG4gICAgICAvLyBBY3RpdmF0ZSBzY3JvbGxiYXIgaG92ZXJlZCBldmVudFxyXG4gICAgICB0cmFja0hvdmVyZWRFdmVudC5waXBlKHRhcCgoZTogYm9vbGVhbikgPT4gdGhpcy5zZXRIb3ZlcmVkKGUpKSksXHJcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0aHVtYiBkcmFnIGV2ZW50XHJcbiAgICAgIHRodW1iRHJhZ0V2ZW50LnBpcGUoc3dpdGNoTWFwKChlOiBNb3VzZUV2ZW50KSA9PiB0aGlzLnRodW1iIS5kcmFnZ2VkKGUpKSksXHJcbiAgICAgIC8vIEFjdGl2YXRlIHNjcm9sbGJhciB0cmFjayBjbGljayBldmVudFxyXG4gICAgICB0cmFja0NsaWNrRXZlbnQucGlwZShzd2l0Y2hNYXAoKGU6IE1vdXNlRXZlbnQpID0+IHRoaXMudHJhY2shLm9uVHJhY2tDbGlja2VkKGUsIHRoaXMudGh1bWIhLnNpemUsIHRoaXMudmlld3BvcnRTY3JvbGxTaXplKSkpXHJcbiAgICApO1xyXG4gIH1cclxuXHJcbiAgLy8gU3RyZWFtIHRoYXQgZW1pdHMgd2hlbiB0aGUgdHJhY2sgZWxlbWVudCBpcyBob3ZlcmVkXHJcbiAgcHJvdGVjdGVkIGdldCBob3ZlcmVkKCk6IE9ic2VydmFibGU8Ym9vbGVhbj4ge1xyXG4gICAgY29uc3QgbW91c2VFbnRlciA9IGZyb21FdmVudDxNb3VzZUV2ZW50Pih0aGlzLmVsLCAnbW91c2VlbnRlcicsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICBzdG9wUHJvcGFnYXRpb24oKSxcclxuICAgICAgbWFwKCgpID0+IHRydWUpXHJcbiAgICApO1xyXG4gICAgY29uc3QgbW91c2VMZWF2ZSA9IGZyb21FdmVudDxNb3VzZUV2ZW50Pih0aGlzLmVsLCAnbW91c2VsZWF2ZScsIHsgcGFzc2l2ZTogdHJ1ZSB9KS5waXBlKFxyXG4gICAgICBzdG9wUHJvcGFnYXRpb24oKSxcclxuICAgICAgbWFwKCgpID0+IGZhbHNlKVxyXG4gICAgKTtcclxuICAgIHJldHVybiBtZXJnZShtb3VzZUVudGVyLCBtb3VzZUxlYXZlKTtcclxuICB9XHJcblxyXG4gIG5nT25Jbml0KCkge1xyXG4gICAgdGhpcy56b25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcclxuICAgICAgLy8gQWN0aXZhdGUgcG9pbnRlciBldmVudHMgb24gRGVza3RvcCBvbmx5XHJcbiAgICAgIGlmICghKHRoaXMucGxhdGZvcm0uSU9TIHx8IHRoaXMucGxhdGZvcm0uQU5EUk9JRCkgJiYgIXRoaXMuY21wLnBvaW50ZXJFdmVudHNEaXNhYmxlZCkge1xyXG4gICAgICAgIHRoaXMuYWN0aXZhdGVQb2ludGVyRXZlbnRzKCkucGlwZSh0YWtlVW50aWwodGhpcy5kZXN0cm95ZWQpKS5zdWJzY3JpYmUoKTtcclxuICAgICAgfVxyXG5cclxuICAgICAgLy8gVXBkYXRlIHNjcm9sbGJhciB0aHVtYiB3aGVuIHZpZXdwb3J0IGlzIHNjcm9sbGVkIGFuZCB3aGVuIHNjcm9sbGJhciBjb21wb25lbnQgaXMgdXBkYXRlZFxyXG4gICAgICBtZXJnZSh0aGlzLmNtcC5zY3JvbGxlZCwgdGhpcy5jbXAudXBkYXRlZCkucGlwZShcclxuICAgICAgICB0YXAoKCkgPT4gdGhpcy50aHVtYj8udXBkYXRlKCkpLFxyXG4gICAgICAgIHRha2VVbnRpbCh0aGlzLmRlc3Ryb3llZClcclxuICAgICAgKS5zdWJzY3JpYmUoKTtcclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgbmdPbkRlc3Ryb3koKSB7XHJcbiAgICB0aGlzLmRlc3Ryb3llZC5uZXh0KCk7XHJcbiAgICB0aGlzLmRlc3Ryb3llZC5jb21wbGV0ZSgpO1xyXG5cclxuICAgIC8vIENsZWFuIHVwIHZpZXdwb3J0IHN0cmVhbXMgaWYgdXNlZFxyXG4gICAgaWYgKHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQgJiYgdGhpcy52aWV3cG9ydFRyYWNrQ2xpY2tlZCkge1xyXG4gICAgICB0aGlzLnZpZXdwb3J0VHJhY2tDbGlja2VkLmNvbXBsZXRlKCk7XHJcbiAgICAgIHRoaXMudmlld3BvcnRUaHVtYkNsaWNrZWQuY29tcGxldGUoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByb3RlY3RlZCBhYnN0cmFjdCBzZXRIb3ZlcmVkKHZhbHVlOiBib29sZWFuKTogdm9pZDtcclxufVxyXG4iXX0=