import { Directive, Input, Output, Inject, PLATFORM_ID, NgZone, } from '@angular/core';
import { isPlatformBrowser } from '@angular/common';
import { Subject, BehaviorSubject, Observable, defer } from 'rxjs';
import { filter, switchMap, takeUntil } from 'rxjs/operators';
import { AnimationLoader } from './animation-loader';
import * as i0 from "@angular/core";
import * as i1 from "./animation-loader";
export class BaseDirective {
    constructor(ngZone, platformId, animationLoader) {
        this.ngZone = ngZone;
        this.platformId = platformId;
        this.animationLoader = animationLoader;
        this.options = null;
        this.containerClass = null;
        this.styles = null;
        /**
         * `animationCreated` is dispatched after calling `loadAnimation`.
         */
        this.animationCreated = this.getAnimationItem();
        /**
         * `complete` is dispatched after completing the last frame.
         */
        this.complete = this.awaitAnimationItemAndStartListening('complete');
        /**
         * `loopComplete` is dispatched after completing the frame loop.
         */
        this.loopComplete = this.awaitAnimationItemAndStartListening('loopComplete');
        /**
         * `enterFrame` is dispatched after entering the new frame.
         */
        this.enterFrame = this.awaitAnimationItemAndStartListening('enterFrame');
        /**
         * `segmentStart` is dispatched when the new segment is adjusted.
         */
        this.segmentStart = this.awaitAnimationItemAndStartListening('segmentStart');
        /**
         * Original event name is `config_ready`. `config_ready` is dispatched
         * after the needed renderer is configured.
         */
        this.configReady = this.awaitAnimationItemAndStartListening('config_ready');
        /**
         * Original event name is `data_ready`. `data_ready` is dispatched
         * when all parts of the animation have been loaded.
         */
        this.dataReady = this.awaitAnimationItemAndStartListening('data_ready');
        /**
         * Original event name is `DOMLoaded`. `DOMLoaded` is dispatched
         * when elements have been added to the DOM.
         */
        this.domLoaded = this.awaitAnimationItemAndStartListening('DOMLoaded');
        /**
         * `destroy` will be dispatched when the component gets destroyed,
         * it's handy for releasing resources.
         */
        this.destroy = this.awaitAnimationItemAndStartListening('destroy');
        /**
         * `error` will be dispatched if the Lottie player could not render
         * some frame or parse config.
         */
        this.error = this.awaitAnimationItemAndStartListening('error');
        this.destroy$ = new Subject();
        this.loadAnimation$ = new Subject();
        this.animationItem$ = new BehaviorSubject(null);
        this.setupLoadAnimationListener();
    }
    ngOnDestroy() {
        this.destroy$.next();
        this.destroyAnimation();
    }
    loadAnimation(changes, container) {
        // The `loadAnimation` may load `lottie-web` asynchronously and also pipes the player
        // with `animationFrameScheduler`, which schedules an animation task and triggers change
        // detection. We'll trigger change detection only once when the animation item is created.
        this.ngZone.runOutsideAngular(() => this.loadAnimation$.next([changes, container]));
    }
    getAnimationItem() {
        return defer(() => this.animationItem$).pipe(filter((animationItem) => animationItem !== null));
    }
    awaitAnimationItemAndStartListening(name) {
        return this.getAnimationItem().pipe(switchMap(animationItem => 
        // `fromEvent` will try to call `removeEventListener` when `unsubscribe()` is invoked.
        // The problem is that `ngOnDestroy()` is called before Angular unsubscribes from
        // `@Output()` properties, thus `animationItem` will be `null` already, also `lottie-web`
        // removes event listeners when calling `destroy()`.
        new Observable(observer => {
            this.ngZone.runOutsideAngular(() => {
                animationItem.addEventListener(name, event => {
                    this.ngZone.runOutsideAngular(() => {
                        observer.next(event);
                    });
                });
            });
        })));
    }
    setupLoadAnimationListener() {
        const loadAnimation$ = this.loadAnimation$.pipe(filter(([changes]) => isPlatformBrowser(this.platformId) && changes.options !== undefined));
        loadAnimation$
            .pipe(switchMap(([changes, container]) => {
            this.destroyAnimation();
            return this.animationLoader.loadAnimation(this.animationLoader.resolveOptions(changes.options.currentValue, container));
        }), takeUntil(this.destroy$))
            .subscribe(animationItem => {
            this.ngZone.run(() => this.animationItem$.next(animationItem));
        });
    }
    destroyAnimation() {
        const animationItem = this.animationItem$.getValue();
        // The `ng-lottie` component or the `lottie` directive can be destroyed
        // before the `animationItem` is set, thus it will fail with
        // `Cannot read property 'destroy' of null`.
        // Potentially it can happen if the directive gets destroyed before change
        // detection is run.
        if (animationItem === null) {
            return;
        }
        // `destroy()` will remove all events listeners.
        animationItem.destroy();
        this.animationItem$.next(null);
    }
}
/** @nocollapse */ BaseDirective.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "15.0.0", ngImport: i0, type: BaseDirective, deps: [{ token: i0.NgZone }, { token: PLATFORM_ID }, { token: i1.AnimationLoader }], target: i0.ɵɵFactoryTarget.Directive });
/** @nocollapse */ BaseDirective.ɵdir = i0.ɵɵngDeclareDirective({ minVersion: "14.0.0", version: "15.0.0", type: BaseDirective, selector: "[lottie]", inputs: { options: "options", containerClass: "containerClass", styles: "styles" }, outputs: { animationCreated: "animationCreated", complete: "complete", loopComplete: "loopComplete", enterFrame: "enterFrame", segmentStart: "segmentStart", configReady: "configReady", dataReady: "dataReady", domLoaded: "domLoaded", destroy: "destroy", error: "error" }, ngImport: i0 });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "15.0.0", ngImport: i0, type: BaseDirective, decorators: [{
            type: Directive,
            args: [{ selector: '[lottie]' }]
        }], ctorParameters: function () { return [{ type: i0.NgZone }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [PLATFORM_ID]
                }] }, { type: i1.AnimationLoader }]; }, propDecorators: { options: [{
                type: Input
            }], containerClass: [{
                type: Input
            }], styles: [{
                type: Input
            }], animationCreated: [{
                type: Output
            }], complete: [{
                type: Output
            }], loopComplete: [{
                type: Output
            }], enterFrame: [{
                type: Output
            }], segmentStart: [{
                type: Output
            }], configReady: [{
                type: Output
            }], dataReady: [{
                type: Output
            }], domLoaded: [{
                type: Output
            }], destroy: [{
                type: Output
            }], error: [{
                type: Output
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmFzZS5kaXJlY3RpdmUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi9saWJzL25neC1sb3R0aWUvc3JjL2xpYi9iYXNlLmRpcmVjdGl2ZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQ0wsU0FBUyxFQUNULEtBQUssRUFDTCxNQUFNLEVBQ04sTUFBTSxFQUNOLFdBQVcsRUFHWCxNQUFNLEdBQ1AsTUFBTSxlQUFlLENBQUM7QUFDdkIsT0FBTyxFQUFFLGlCQUFpQixFQUFFLE1BQU0saUJBQWlCLENBQUM7QUFFcEQsT0FBTyxFQUFFLE9BQU8sRUFBRSxlQUFlLEVBQUUsVUFBVSxFQUFFLEtBQUssRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUNuRSxPQUFPLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsTUFBTSxnQkFBZ0IsQ0FBQztBQWM5RCxPQUFPLEVBQUUsZUFBZSxFQUFFLE1BQU0sb0JBQW9CLENBQUM7OztBQUdyRCxNQUFNLE9BQU8sYUFBYTtJQXNFeEIsWUFDVSxNQUFjLEVBQ08sVUFBa0IsRUFDdkMsZUFBZ0M7UUFGaEMsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUNPLGVBQVUsR0FBVixVQUFVLENBQVE7UUFDdkMsb0JBQWUsR0FBZixlQUFlLENBQWlCO1FBeEVqQyxZQUFPLEdBQTRCLElBQUksQ0FBQztRQUV4QyxtQkFBYyxHQUFrQixJQUFJLENBQUM7UUFFckMsV0FBTSxHQUF3QyxJQUFJLENBQUM7UUFFNUQ7O1dBRUc7UUFDTyxxQkFBZ0IsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztRQUVyRDs7V0FFRztRQUNPLGFBQVEsR0FBRyxJQUFJLENBQUMsbUNBQW1DLENBQWtCLFVBQVUsQ0FBQyxDQUFDO1FBRTNGOztXQUVHO1FBQ08saUJBQVksR0FDcEIsSUFBSSxDQUFDLG1DQUFtQyxDQUFzQixjQUFjLENBQUMsQ0FBQztRQUVoRjs7V0FFRztRQUNPLGVBQVUsR0FB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LFlBQVk7c0JBQXJCLE1BQU07Z0JBTUcsVUFBVTtzQkFBbkIsTUFBTTtnQkFLRyxZQUFZO3NCQUFyQixNQUFNO2dCQU9HLFdBQVc7c0JBQXBCLE1BQU07Z0JBTUcsU0FBUztzQkFBbEIsTUFBTTtnQkFNRyxTQUFTO3NCQUFsQixNQUFNO2dCQU1HLE9BQU87c0JBQWhCLE1BQU07Z0JBTUcsS0FBSztzQkFBZCxNQUFNIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcbiAgRGlyZWN0aXZlLFxuICBJbnB1dCxcbiAgT3V0cHV0LFxuICBJbmplY3QsXG4gIFBMQVRGT1JNX0lELFxuICBPbkRlc3Ryb3ksXG4gIFNpbXBsZUNoYW5nZXMsXG4gIE5nWm9uZSxcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XG5pbXBvcnQgeyBpc1BsYXRmb3JtQnJvd3NlciB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbic7XG5cbmltcG9ydCB7IFN1YmplY3QsIEJlaGF2aW9yU3ViamVjdCwgT2JzZXJ2YWJsZSwgZGVmZXIgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IGZpbHRlciwgc3dpdGNoTWFwLCB0YWtlVW50aWwgfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XG5cbmltcG9ydCB7XG4gIEFuaW1hdGlvbk9wdGlvbnMsXG4gIEJNQ29tcGxldGVFdmVudCxcbiAgQk1Db21wbGV0ZUxvb3BFdmVudCxcbiAgQk1FbnRlckZyYW1lRXZlbnQsXG4gIEJNU2VnbWVudFN0YXJ0RXZlbnQsXG4gIEJNRGVzdHJveUV2ZW50LFxuICBCTVJlbmRlckZyYW1lRXJyb3JFdmVudCxcbiAgQk1Db25maWdFcnJvckV2ZW50LFxuICBBbmltYXRpb25JdGVtLFxuICBBbmltYXRpb25FdmVudE5hbWUsXG59IGZyb20gJy4vc3ltYm9scyc7XG5pbXBvcnQgeyBBbmltYXRpb25Mb2FkZXIgfSBmcm9tICcuL2FuaW1hdGlvbi1sb2FkZXInO1xuXG5ARGlyZWN0aXZlKHsgc2VsZWN0b3I6ICdbbG90dGllXScgfSlcbmV4cG9ydCBjbGFzcyBCYXNlRGlyZWN0aXZlIGltcGxlbWVudHMgT25EZXN0cm95IHtcbiAgQElucHV0KCkgb3B0aW9uczogQW5pbWF0aW9uT3B0aW9ucyB8IG51bGwgPSBudWxsO1xuXG4gIEBJbnB1dCgpIGNvbnRhaW5lckNsYXNzOiBzdHJpbmcgfCBudWxsID0gbnVsbDtcblxuICBASW5wdXQoKSBzdHlsZXM6IFBhcnRpYWw8Q1NTU3R5bGVEZWNsYXJhdGlvbj4gfCBudWxsID0gbnVsbDtcblxuICAvKipcbiAgICogYGFuaW1hdGlvbkNyZWF0ZWRgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgY2FsbGluZyBgbG9hZEFuaW1hdGlvbmAuXG4gICAqL1xuICBAT3V0cHV0KCkgYW5pbWF0aW9uQ3JlYXRlZCA9IHRoaXMuZ2V0QW5pbWF0aW9uSXRlbSgpO1xuXG4gIC8qKlxuICAgKiBgY29tcGxldGVgIGlzIGRpc3BhdGNoZWQgYWZ0ZXIgY29tcGxldGluZyB0aGUgbGFzdCBmcmFtZS5cbiAgICovXG4gIEBPdXRwdXQoKSBjb21wbGV0ZSA9IHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1Db21wbGV0ZUV2ZW50PignY29tcGxldGUnKTtcblxuICAvKipcbiAgICogYGxvb3BDb21wbGV0ZWAgaXMgZGlzcGF0Y2hlZCBhZnRlciBjb21wbGV0aW5nIHRoZSBmcmFtZSBsb29wLlxuICAgKi9cbiAgQE91dHB1dCgpIGxvb3BDb21wbGV0ZSA9XG4gICAgdGhpcy5hd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxCTUNvbXBsZXRlTG9vcEV2ZW50PignbG9vcENvbXBsZXRlJyk7XG5cbiAgLyoqXG4gICAqIGBlbnRlckZyYW1lYCBpcyBkaXNwYXRjaGVkIGFmdGVyIGVudGVyaW5nIHRoZSBuZXcgZnJhbWUuXG4gICAqL1xuICBAT3V0cHV0KCkgZW50ZXJGcmFtZSA9IHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1FbnRlckZyYW1lRXZlbnQ+KCdlbnRlckZyYW1lJyk7XG5cbiAgLyoqXG4gICAqIGBzZWdtZW50U3RhcnRgIGlzIGRpc3BhdGNoZWQgd2hlbiB0aGUgbmV3IHNlZ21lbnQgaXMgYWRqdXN0ZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgc2VnbWVudFN0YXJ0ID1cbiAgICB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPEJNU2VnbWVudFN0YXJ0RXZlbnQ+KCdzZWdtZW50U3RhcnQnKTtcblxuICAvKipcbiAgICogT3JpZ2luYWwgZXZlbnQgbmFtZSBpcyBgY29uZmlnX3JlYWR5YC4gYGNvbmZpZ19yZWFkeWAgaXMgZGlzcGF0Y2hlZFxuICAgKiBhZnRlciB0aGUgbmVlZGVkIHJlbmRlcmVyIGlzIGNvbmZpZ3VyZWQuXG4gICAqL1xuICBAT3V0cHV0KCkgY29uZmlnUmVhZHkgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPHZvaWQ+KCdjb25maWdfcmVhZHknKTtcblxuICAvKipcbiAgICogT3JpZ2luYWwgZXZlbnQgbmFtZSBpcyBgZGF0YV9yZWFkeWAuIGBkYXRhX3JlYWR5YCBpcyBkaXNwYXRjaGVkXG4gICAqIHdoZW4gYWxsIHBhcnRzIG9mIHRoZSBhbmltYXRpb24gaGF2ZSBiZWVuIGxvYWRlZC5cbiAgICovXG4gIEBPdXRwdXQoKSBkYXRhUmVhZHkgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPHZvaWQ+KCdkYXRhX3JlYWR5Jyk7XG5cbiAgLyoqXG4gICAqIE9yaWdpbmFsIGV2ZW50IG5hbWUgaXMgYERPTUxvYWRlZGAuIGBET01Mb2FkZWRgIGlzIGRpc3BhdGNoZWRcbiAgICogd2hlbiBlbGVtZW50cyBoYXZlIGJlZW4gYWRkZWQgdG8gdGhlIERPTS5cbiAgICovXG4gIEBPdXRwdXQoKSBkb21Mb2FkZWQgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPHZvaWQ+KCdET01Mb2FkZWQnKTtcblxuICAvKipcbiAgICogYGRlc3Ryb3lgIHdpbGwgYmUgZGlzcGF0Y2hlZCB3aGVuIHRoZSBjb21wb25lbnQgZ2V0cyBkZXN0cm95ZWQsXG4gICAqIGl0J3MgaGFuZHkgZm9yIHJlbGVhc2luZyByZXNvdXJjZXMuXG4gICAqL1xuICBAT3V0cHV0KCkgZGVzdHJveSA9IHRoaXMuYXdhaXRBbmltYXRpb25JdGVtQW5kU3RhcnRMaXN0ZW5pbmc8Qk1EZXN0cm95RXZlbnQ+KCdkZXN0cm95Jyk7XG5cbiAgLyoqXG4gICAqIGBlcnJvcmAgd2lsbCBiZSBkaXNwYXRjaGVkIGlmIHRoZSBMb3R0aWUgcGxheWVyIGNvdWxkIG5vdCByZW5kZXJcbiAgICogc29tZSBmcmFtZSBvciBwYXJzZSBjb25maWcuXG4gICAqL1xuICBAT3V0cHV0KCkgZXJyb3IgPSB0aGlzLmF3YWl0QW5pbWF0aW9uSXRlbUFuZFN0YXJ0TGlzdGVuaW5nPFxuICAgIEJNUmVuZGVyRnJhbWVFcnJvckV2ZW50IHwgQk1Db25maWdFcnJvckV2ZW50XG4gID4oJ2Vycm9yJyk7XG5cbiAgcHJpdmF0ZSBkZXN0cm95JCA9IG5ldyBTdWJqZWN0PHZvaWQ+KCk7XG4gIHByaXZhdGUgbG9hZEFuaW1hdGlvbiQgPSBuZXcgU3ViamVjdDxbU2ltcGxlQ2hhbmdlcywgSFRNTEVsZW1lbnRdPigpO1xuICBwcml2YXRlIGFuaW1hdGlvbkl0ZW0kID0gbmV3IEJlaGF2aW9yU3ViamVjdDxBbmltYXRpb25JdGVtIHwgbnVsbD4obnVsbCk7XG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBuZ1pvbmU6IE5nWm9uZSxcbiAgICBASW5qZWN0KFBMQVRGT1JNX0lEKSBwcml2YXRlIHBsYXRmb3JtSWQ6IHN0cmluZyxcbiAgICBwcml2YXRlIGFuaW1hdGlvbkxvYWRlcjogQW5pbWF0aW9uTG9hZGVyLFxuICApIHtcbiAgICB0aGlzLnNldHVwTG9hZEFuaW1hdGlvbkxpc3RlbmVyKCk7XG4gIH1cblxuICBuZ09uRGVzdHJveSgpOiB2b2lkIHtcbiAgICB0aGlzLmRlc3Ryb3kkLm5leHQoKTtcbiAgICB0aGlzLmRlc3Ryb3lBbmltYXRpb24oKTtcbiAgfVxuXG4gIHByb3RlY3RlZCBsb2FkQW5pbWF0aW9uKGNoYW5nZXM6IFNpbXBsZUNoYW5nZXMsIGNvbnRhaW5lcjogSFRNTEVsZW1lbnQpOiB2b2lkIHtcbiAgICAvLyBUaGUgYGxvYWRBbmltYXRpb25gIG1heSBsb2FkIGBsb3R0aWUtd2ViYCBhc3luY2hyb25vdXNseSBhbmQgYWxzbyBwaXBlcyB0aGUgcGxheWVyXG4gICAgLy8gd2l0aCBgYW5pbWF0aW9uRnJhbWVTY2hlZHVsZXJgLCB3aGljaCBzY2hlZHVsZXMgYW4gYW5pbWF0aW9uIHRhc2sgYW5kIHRyaWdnZXJzIGNoYW5nZVxuICAgIC8vIGRldGVjdGlvbi4gV2UnbGwgdHJpZ2dlciBjaGFuZ2UgZGV0ZWN0aW9uIG9ubHkgb25jZSB3aGVuIHRoZSBhbmltYXRpb24gaXRlbSBpcyBjcmVhdGVkLlxuICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHRoaXMubG9hZEFuaW1hdGlvbiQubmV4dChbY2hhbmdlcywgY29udGFpbmVyXSkpO1xuICB9XG5cbiAgcHJpdmF0ZSBnZXRBbmltYXRpb25JdGVtKCk6IE9ic2VydmFibGU8QW5pbWF0aW9uSXRlbT4ge1xuICAgIHJldHVybiBkZWZlcigoKSA9PiB0aGlzLmFuaW1hdGlvbkl0ZW0kKS5waXBlKFxuICAgICAgZmlsdGVyKFxuICAgICAgICAoYW5pbWF0aW9uSXRlbTogQW5pbWF0aW9uSXRlbSB8IG51bGwpOiBhbmltYXRpb25JdGVtIGlzIEFuaW1hdGlvbkl0ZW0gPT5cbiAgICAgICAgICBhbmltYXRpb25JdGVtICE9PSBudWxsLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBhd2FpdEFuaW1hdGlvbkl0ZW1BbmRTdGFydExpc3RlbmluZzxUPihuYW1lOiBBbmltYXRpb25FdmVudE5hbWUpOiBPYnNlcnZhYmxlPFQ+IHtcbiAgICByZXR1cm4gdGhpcy5nZXRBbmltYXRpb25JdGVtKCkucGlwZShcbiAgICAgIHN3aXRjaE1hcChcbiAgICAgICAgYW5pbWF0aW9uSXRlbSA9PlxuICAgICAgICAgIC8vIGBmcm9tRXZlbnRgIHdpbGwgdHJ5IHRvIGNhbGwgYHJlbW92ZUV2ZW50TGlzdGVuZXJgIHdoZW4gYHVuc3Vic2NyaWJlKClgIGlzIGludm9rZWQuXG4gICAgICAgICAgLy8gVGhlIHByb2JsZW0gaXMgdGhhdCBgbmdPbkRlc3Ryb3koKWAgaXMgY2FsbGVkIGJlZm9yZSBBbmd1bGFyIHVuc3Vic2NyaWJlcyBmcm9tXG4gICAgICAgICAgLy8gYEBPdXRwdXQoKWAgcHJvcGVydGllcywgdGh1cyBgYW5pbWF0aW9uSXRlbWAgd2lsbCBiZSBgbnVsbGAgYWxyZWFkeSwgYWxzbyBgbG90dGllLXdlYmBcbiAgICAgICAgICAvLyByZW1vdmVzIGV2ZW50IGxpc3RlbmVycyB3aGVuIGNhbGxpbmcgYGRlc3Ryb3koKWAuXG4gICAgICAgICAgbmV3IE9ic2VydmFibGU8VD4ob2JzZXJ2ZXIgPT4ge1xuICAgICAgICAgICAgdGhpcy5uZ1pvbmUucnVuT3V0c2lkZUFuZ3VsYXIoKCkgPT4ge1xuICAgICAgICAgICAgICBhbmltYXRpb25JdGVtLmFkZEV2ZW50TGlzdGVuZXI8VD4obmFtZSwgZXZlbnQgPT4ge1xuICAgICAgICAgICAgICAgIHRoaXMubmdab25lLnJ1bk91dHNpZGVBbmd1bGFyKCgpID0+IHtcbiAgICAgICAgICAgICAgICAgIG9ic2VydmVyLm5leHQoZXZlbnQpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH0pLFxuICAgICAgKSxcbiAgICApO1xuICB9XG5cbiAgcHJpdmF0ZSBzZXR1cExvYWRBbmltYXRpb25MaXN0ZW5lcigpOiB2b2lkIHtcbiAgICBjb25zdCBsb2FkQW5pbWF0aW9uJCA9IHRoaXMubG9hZEFuaW1hdGlvbiQucGlwZShcbiAgICAgIGZpbHRlcigoW2NoYW5nZXNdKSA9PiBpc1BsYXRmb3JtQnJvd3Nlcih0aGlzLnBsYXRmb3JtSWQpICYmIGNoYW5nZXMub3B0aW9ucyAhPT0gdW5kZWZpbmVkKSxcbiAgICApO1xuXG4gICAgbG9hZEFuaW1hdGlvbiRcbiAgICAgIC5waXBlKFxuICAgICAgICBzd2l0Y2hNYXAoKFtjaGFuZ2VzLCBjb250YWluZXJdKSA9PiB7XG4gICAgICAgICAgdGhpcy5kZXN0cm95QW5pbWF0aW9uKCk7XG4gICAgICAgICAgcmV0dXJuIHRoaXMuYW5pbWF0aW9uTG9hZGVyLmxvYWRBbmltYXRpb24oXG4gICAgICAgICAgICB0aGlzLmFuaW1hdGlvbkxvYWRlci5yZXNvbHZlT3B0aW9ucyhjaGFuZ2VzLm9wdGlvbnMuY3VycmVudFZhbHVlLCBjb250YWluZXIpLFxuICAgICAgICAgICk7XG4gICAgICAgIH0pLFxuICAgICAgICB0YWtlVW50aWwodGhpcy5kZXN0cm95JCksXG4gICAgICApXG4gICAgICAuc3Vic2NyaWJlKGFuaW1hdGlvbkl0ZW0gPT4ge1xuICAgICAgICB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5hbmltYXRpb25JdGVtJC5uZXh0KGFuaW1hdGlvbkl0ZW0pKTtcbiAgICAgIH0pO1xuICB9XG5cbiAgcHJpdmF0ZSBkZXN0cm95QW5pbWF0aW9uKCk6IHZvaWQge1xuICAgIGNvbnN0IGFuaW1hdGlvbkl0ZW0gPSB0aGlzLmFuaW1hdGlvbkl0ZW0kLmdldFZhbHVlKCk7XG4gICAgLy8gVGhlIGBuZy1sb3R0aWVgIGNvbXBvbmVudCBvciB0aGUgYGxvdHRpZWAgZGlyZWN0aXZlIGNhbiBiZSBkZXN0cm95ZWRcbiAgICAvLyBiZWZvcmUgdGhlIGBhbmltYXRpb25JdGVtYCBpcyBzZXQsIHRodXMgaXQgd2lsbCBmYWlsIHdpdGhcbiAgICAvLyBgQ2Fubm90IHJlYWQgcHJvcGVydHkgJ2Rlc3Ryb3knIG9mIG51bGxgLlxuICAgIC8vIFBvdGVudGlhbGx5IGl0IGNhbiBoYXBwZW4gaWYgdGhlIGRpcmVjdGl2ZSBnZXRzIGRlc3Ryb3llZCBiZWZvcmUgY2hhbmdlXG4gICAgLy8gZGV0ZWN0aW9uIGlzIHJ1bi5cbiAgICBpZiAoYW5pbWF0aW9uSXRlbSA9PT0gbnVsbCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIGBkZXN0cm95KClgIHdpbGwgcmVtb3ZlIGFsbCBldmVudHMgbGlzdGVuZXJzLlxuICAgIGFuaW1hdGlvbkl0ZW0uZGVzdHJveSgpO1xuICAgIHRoaXMuYW5pbWF0aW9uSXRlbSQubmV4dChudWxsKTtcbiAgfVxufVxuIl19